name: Publish Release

on:
  workflow_dispatch:
    inputs:
      battery_capacity:
        description: "Battery capacity (mAh) - 电池容量，例如: 5000"
        required: false
        default: ""
      cpu_name:
        description: "CPU display name - 处理器显示名称，例如: Qualcomm Snapdragon 8 Elite"
        required: false
        default: ""
      device_id:
        description: "Device codename (display only, safe) - 设备代号（仅显示用途），例如: alioth"
        required: false
        default: ""
      model_name:
        description: "Model name (ro.product.model) - 机型名称，例如: Redmi K40"
        required: false
        default: ""
      brand:
        description: "Brand name (ro.product.brand) - 品牌名称，例如: Redmi"
        required: false
        default: ""
      manufacturer:
        description: "Manufacturer (ro.product.manufacturer) - 制造商，例如: Xiaomi"
        required: false
        default: ""
      lcd_density:
        description: "LCD density DPI (ro.sf.lcd_density) - 屏幕密度，例如: 440"
        required: false
        default: ""
      product_name:
        description: "Product name (ro.product.name) - 产品名称，例如: PLQ110"
        required: false
        default: ""
      build_product:
        description: "Build product (ro.build.product) - 构建产品名，例如: OP612DL1"
        required: false
        default: ""
      optimize_volume:
        description: "Optimize volume curve - 优化音量曲线（使音量调节更线性）"
        required: false
        type: boolean
        default: false
      brightness_floor:
        description: "Enable brightness floor - 启用最低亮度限制（防止自动亮度在暗环境下黑屏）"
        required: false
        type: boolean
        default: false
      auto_brightness_fix:
        description: "Auto brightness clamp fixer daemon - 自动亮度钳位修复（模块自运行，定期重置自动亮度）"
        required: false
        type: boolean
        default: false
      clean_history:
        description: 'Clean old releases and tags (keep only latest)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      BATTERY_CAPACITY: ${{ github.event.inputs.battery_capacity }}
      CPU_NAME: ${{ github.event.inputs.cpu_name }}
      DEVICE_ID: ${{ github.event.inputs.device_id }}
      MODEL_NAME: ${{ github.event.inputs.model_name }}
      BRAND: ${{ github.event.inputs.brand }}
      MANUFACTURER: ${{ github.event.inputs.manufacturer }}
      LCD_DENSITY: ${{ github.event.inputs.lcd_density }}
      PRODUCT_NAME: ${{ github.event.inputs.product_name }}
      BUILD_PRODUCT: ${{ github.event.inputs.build_product }}
      OPTIMIZE_VOLUME: ${{ github.event.inputs.optimize_volume }}
      BRIGHTNESS_FLOOR: ${{ github.event.inputs.brightness_floor }}
      AUTO_BRIGHTNESS_FIX: ${{ github.event.inputs.auto_brightness_fix }}

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: "17"
        distribution: "temurin"

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Install platform and build-tools
      run: |
        yes | sdkmanager "platforms;android-33" "build-tools;34.0.0"

    - name: Validate Input Parameters
      run: |
        set -euo pipefail

        trim() {
          local value="$1"
          value="${value#${value%%[![:space:]]*}}"
          value="${value%${value##*[![:space:]]}}"
          printf "%s" "$value"
        }

        BATTERY_CAPACITY=$(trim "${BATTERY_CAPACITY}")
        CPU_NAME=$(trim "${CPU_NAME}")
        DEVICE_ID=$(trim "${DEVICE_ID}")
        MODEL_NAME=$(trim "${MODEL_NAME}")
        BRAND=$(trim "${BRAND}")
        MANUFACTURER=$(trim "${MANUFACTURER}")
        LCD_DENSITY=$(trim "${LCD_DENSITY}")
        PRODUCT_NAME=$(trim "${PRODUCT_NAME}")
        BUILD_PRODUCT=$(trim "${BUILD_PRODUCT}")
        
        # Validate battery capacity (if provided) - must be 1000-20000 as documented
        if [ -n "${BATTERY_CAPACITY}" ]; then
          if ! [[ "${BATTERY_CAPACITY}" =~ ^[0-9]+$ ]]; then
            echo "❌ Error: battery_capacity must be a positive integer"
            exit 1
          fi
          if [ "${BATTERY_CAPACITY}" -lt 1000 ] || [ "${BATTERY_CAPACITY}" -gt 20000 ]; then
            echo "❌ Error: battery_capacity must be between 1000-20000 mAh"
            exit 1
          fi
        fi
        
        # Validate LCD density (if provided) - must be 120-640 as documented
        if [ -n "${LCD_DENSITY}" ]; then
          if ! [[ "${LCD_DENSITY}" =~ ^[0-9]+$ ]]; then
            echo "❌ Error: lcd_density must be a positive integer"
            exit 1
          fi
          if [ "${LCD_DENSITY}" -lt 120 ] || [ "${LCD_DENSITY}" -gt 640 ]; then
            echo "❌ Error: lcd_density must be between 120-640 DPI"
            exit 1
          fi
        fi
        
        # Validate device_id format (if provided) - alphanumeric, dash, underscore only
        if [ -n "${DEVICE_ID}" ]; then
          if ! [[ "${DEVICE_ID}" =~ ^[a-zA-Z0-9_-]+$ ]]; then
            echo "❌ Error: device_id should only contain letters, numbers, hyphens and underscores"
            exit 1
          fi
        fi
        
        # Validate product_name format (if provided) - alphanumeric, dash, underscore only
        if [ -n "${PRODUCT_NAME}" ]; then
          if ! [[ "${PRODUCT_NAME}" =~ ^[a-zA-Z0-9_-]+$ ]]; then
            echo "❌ Error: product_name should only contain letters, numbers, hyphens and underscores"
            exit 1
          fi
        fi
        
        # Validate build_product format (if provided) - alphanumeric, dash, underscore only
        if [ -n "${BUILD_PRODUCT}" ]; then
          if ! [[ "${BUILD_PRODUCT}" =~ ^[a-zA-Z0-9_-]+$ ]]; then
            echo "❌ Error: build_product should only contain letters, numbers, hyphens and underscores"
            exit 1
          fi
        fi
        
        # Validate string parameters to prevent injection attacks
        validate_string() {
          local name=$1
          local value=$2
          if [[ "$value" == *$'\n'* || "$value" == *$'\r'* || "$value" == *"="* ]]; then
            echo "❌ Error: $name contains invalid characters (newline, carriage return, or equals sign)"
            exit 1
          fi
          if [[ "$value" == *'`'* || "$value" == *'$'* || "$value" == *'\\'* ]]; then
            echo "❌ Error: $name contains potentially dangerous characters"
            exit 1
          fi
        }
        
        [ -n "${CPU_NAME}" ] && validate_string "cpu_name" "${CPU_NAME}"
        [ -n "${MODEL_NAME}" ] && validate_string "model_name" "${MODEL_NAME}"
        [ -n "${BRAND}" ] && validate_string "brand" "${BRAND}"
        [ -n "${MANUFACTURER}" ] && validate_string "manufacturer" "${MANUFACTURER}"
        
        echo "✅ All input parameters validated successfully"

    - name: Decode Keystore
      run: echo "${{ secrets.SIGNING_KEY }}" | base64 --decode > release.jks

    - name: Clean build artifacts
      run: |
        echo "🧹 Cleaning stale build artifacts..."
        rm -rf build dist
        mkdir -p build dist
        echo "✅ Build environment is clean"

    - name: Build Battery Overlay APK
      if: ${{ github.event.inputs.battery_capacity != '' }}
      env:
        ALIAS: ${{ secrets.ALIAS }}
        KEY_STORE_PASSWORD: ${{ secrets.KEY_STORE_PASSWORD }}
        KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
      run: |
        set -euo pipefail
        echo "🔋 Building battery overlay APK..."
        
        BUILD_TOOL_PATH=$(ls -d "$ANDROID_HOME"/build-tools/* | sort -V | tail -1)
        AAPT2="$BUILD_TOOL_PATH/aapt2"
        APKSIGNER="$BUILD_TOOL_PATH/apksigner"
        ANDROID_JAR="$ANDROID_HOME/platforms/android-33/android.jar"
        
        # Prepare battery overlay resources
        mkdir -p build/battery/res/xml
        
        # Inject battery capacity into template
        sed "s|{{BATTERY_CAPACITY}}|${BATTERY_CAPACITY}|g" \
          overlay-src/battery/res/xml/power_profile.xml.in \
          > build/battery/res/xml/power_profile.xml
        
        cp overlay-src/battery/AndroidManifest.xml build/battery/
        
        # Compile and link
        "$AAPT2" compile --dir build/battery/res -o build/battery/resources.zip
        "$AAPT2" link -o build/battery/unsigned.apk \
          --auto-add-overlay \
          -I "$ANDROID_JAR" \
          --manifest build/battery/AndroidManifest.xml \
          build/battery/resources.zip
        
        # Sign APK
        "$APKSIGNER" sign --ks release.jks \
          --ks-key-alias "$ALIAS" \
          --ks-pass pass:${KEY_STORE_PASSWORD} \
          --key-pass pass:${KEY_PASSWORD} \
          --out build/battery-overlay.apk \
          build/battery/unsigned.apk
        
        echo "✅ Battery overlay APK built successfully"

    - name: Build CPU Overlay APK
      if: ${{ github.event.inputs.cpu_name != '' }}
      env:
        ALIAS: ${{ secrets.ALIAS }}
        KEY_STORE_PASSWORD: ${{ secrets.KEY_STORE_PASSWORD }}
        KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
      run: |
        set -euo pipefail
        echo "🖥️ Building CPU overlay APK..."
        
        BUILD_TOOL_PATH=$(ls -d "$ANDROID_HOME"/build-tools/* | sort -V | tail -1)
        AAPT2="$BUILD_TOOL_PATH/aapt2"
        APKSIGNER="$BUILD_TOOL_PATH/apksigner"
        ANDROID_JAR="$ANDROID_HOME/platforms/android-33/android.jar"
        
        # Prepare CPU overlay resources
        mkdir -p build/cpu/res/values
        
        # XML-escape CPU_NAME to handle &, <, >, ', " safely
        xml_escape() {
          printf '%s' "$1" | sed -e 's/&/\&amp;/g' -e 's/</\&lt;/g' -e 's/>/\&gt;/g' -e "s/'/\&apos;/g" -e 's/"/\&quot;/g'
        }
        
        # Escape for sed replacement (we use # as delimiter)
        # Need to escape: \, &, #, and newlines
        sed_escape() {
          printf '%s' "$1" | sed -e 's/\\/\\\\/g' -e 's/[&#]/\\&/g'
        }
        
        CPU_NAME_ESCAPED=$(xml_escape "${CPU_NAME}")
        CPU_NAME_SED=$(sed_escape "${CPU_NAME_ESCAPED}")
        
        # Inject CPU name into template (use # as delimiter to avoid issues with /)
        sed "s#{{CPU_NAME}}#${CPU_NAME_SED}#g" \
          overlay-src/cpu/res/values/strings.xml.in \
          > build/cpu/res/values/strings.xml
        
        cp overlay-src/cpu/AndroidManifest.xml build/cpu/
        
        # Compile and link
        "$AAPT2" compile --dir build/cpu/res -o build/cpu/resources.zip
        "$AAPT2" link -o build/cpu/unsigned.apk \
          --auto-add-overlay \
          -I "$ANDROID_JAR" \
          --manifest build/cpu/AndroidManifest.xml \
          build/cpu/resources.zip
        
        # Sign APK
        "$APKSIGNER" sign --ks release.jks \
          --ks-key-alias "$ALIAS" \
          --ks-pass pass:${KEY_STORE_PASSWORD} \
          --key-pass pass:${KEY_PASSWORD} \
          --out build/cpu-overlay.apk \
          build/cpu/unsigned.apk
        
        echo "✅ CPU overlay APK built successfully"

    - name: Generate system.prop
      run: |
        set -euo pipefail

        trim() {
          local value="$1"
          value="${value#${value%%[![:space:]]*}}"
          value="${value%${value##*[![:space:]]}}"
          printf "%s" "$value"
        }
        
        # Sanitize value for system.prop: remove newlines and = to prevent injection
        sanitize_prop_value() {
          printf '%s' "$1" | tr -d '\r\n=' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//'
        }

        DEVICE_ID=$(trim "${DEVICE_ID}")
        MODEL_NAME=$(sanitize_prop_value "$(trim "${MODEL_NAME}")")
        BRAND=$(sanitize_prop_value "$(trim "${BRAND}")")
        MANUFACTURER=$(sanitize_prop_value "$(trim "${MANUFACTURER}")")
        LCD_DENSITY=$(trim "${LCD_DENSITY}")
        PRODUCT_NAME=$(trim "${PRODUCT_NAME}")
        BUILD_PRODUCT=$(trim "${BUILD_PRODUCT}")

        # Generate system.prop with all provided properties
        if [ -n "${DEVICE_ID}" ] || [ -n "${MODEL_NAME}" ] || [ -n "${BRAND}" ] || [ -n "${MANUFACTURER}" ] || [ -n "${LCD_DENSITY}" ] || [ -n "${PRODUCT_NAME}" ] || [ -n "${BUILD_PRODUCT}" ]; then
          echo "🔧 Generating system.prop with custom properties:"
          {
            if [ -n "${DEVICE_ID}" ]; then
              echo "ro.product.device.display=${DEVICE_ID}"
              echo "ro.vendor.product.device.display=${DEVICE_ID}"
              echo "  ✓ Device ID (display): ${DEVICE_ID}" >&2
            fi
            
            if [ -n "${MODEL_NAME}" ]; then
              echo "ro.product.model=${MODEL_NAME}"
              echo "ro.product.system.model=${MODEL_NAME}"
              echo "ro.product.vendor.model=${MODEL_NAME}"
              echo "ro.product.odm.model=${MODEL_NAME}"
              echo "ro.product.marketname=${MODEL_NAME}"
              echo "ro.product.odm.marketname=${MODEL_NAME}"
              echo "ro.product.vendor.marketname=${MODEL_NAME}"
              echo "ro.vendor.oplus.market.name=${MODEL_NAME}"
              echo "ro.oppo.market.name=${MODEL_NAME}"
              echo "ro.oppo.market.enname=${MODEL_NAME}"
              echo "ro.vendor.oplus.market.enname=${MODEL_NAME}"
              echo "ro.vendor.vivo.market.name=${MODEL_NAME}"
              echo "ro.vivo.market.name=${MODEL_NAME}"
              echo "ro.config.marketing_name=${MODEL_NAME}"
              echo "ro.vendor.product.ztename=${MODEL_NAME}"
              echo "ro.vendor.asus.product.mkt_name=${MODEL_NAME}"
              echo "ro.lge.petname=${MODEL_NAME}"
              echo "ro.boot.vendor.lge.petname=${MODEL_NAME}"
              echo "  ✓ Model: ${MODEL_NAME} (with marketname for all vendors)" >&2
            fi
            
            if [ -n "${BRAND}" ]; then
              echo "ro.product.brand=${BRAND}"
              echo "ro.product.system.brand=${BRAND}"
              echo "ro.product.vendor.brand=${BRAND}"
              echo "  ✓ Brand: ${BRAND}" >&2
            fi
            
            if [ -n "${MANUFACTURER}" ]; then
              echo "ro.product.manufacturer=${MANUFACTURER}"
              echo "ro.product.system.manufacturer=${MANUFACTURER}"
              echo "ro.product.vendor.manufacturer=${MANUFACTURER}"
              echo "  ✓ Manufacturer: ${MANUFACTURER}" >&2
            fi
            
            if [ -n "${LCD_DENSITY}" ]; then
              echo "ro.sf.lcd_density=${LCD_DENSITY}"
              echo "  ✓ LCD Density: ${LCD_DENSITY} DPI" >&2
            fi
            
            if [ -n "${PRODUCT_NAME}" ]; then
              echo "ro.product.name=${PRODUCT_NAME}"
              echo "ro.product.system.name=${PRODUCT_NAME}"
              echo "ro.product.vendor.name=${PRODUCT_NAME}"
              echo "  ✓ Product Name: ${PRODUCT_NAME}" >&2
            fi
            
            if [ -n "${BUILD_PRODUCT}" ]; then
              echo "ro.build.product=${BUILD_PRODUCT}"
              echo "  ✓ Build Product: ${BUILD_PRODUCT}" >&2
            fi
          } > build/system.prop
          echo "✓ system.prop generated"
        else
          echo "ℹ️  No system properties to override"
        fi

    - name: Package Magisk Module
      run: |
        set -euo pipefail

        trim() {
          local value="$1"
          value="${value#${value%%[![:space:]]*}}"
          value="${value%${value##*[![:space:]]}}"
          printf "%s" "$value"
        }

        sanitize() {
          echo "$1" | sed 's/[^A-Za-z0-9._-]/-/g'
        }

        BATTERY_CAPACITY=$(trim "${BATTERY_CAPACITY}")
        CPU_NAME=$(trim "${CPU_NAME}")
        DEVICE_ID=$(trim "${DEVICE_ID}")
        MODEL_NAME=$(trim "${MODEL_NAME}")
        BRAND=$(trim "${BRAND}")
        LCD_DENSITY=$(trim "${LCD_DENSITY}")
        PRODUCT_NAME=$(trim "${PRODUCT_NAME}")
        BUILD_PRODUCT=$(trim "${BUILD_PRODUCT}")

        BUILD_SUFFIX=""
        [ -n "${BATTERY_CAPACITY}" ] && BUILD_SUFFIX="${BUILD_SUFFIX}-cap${BATTERY_CAPACITY}mAh"
        [ -n "${CPU_NAME}" ] && BUILD_SUFFIX="${BUILD_SUFFIX}-cpu$(sanitize "${CPU_NAME}" | cut -c1-20)"
        [ -n "${DEVICE_ID}" ] && BUILD_SUFFIX="${BUILD_SUFFIX}-dev$(sanitize "${DEVICE_ID}")"
        [ -n "${MODEL_NAME}" ] && BUILD_SUFFIX="${BUILD_SUFFIX}-model$(sanitize "${MODEL_NAME}")"
        [ -n "${BRAND}" ] && BUILD_SUFFIX="${BUILD_SUFFIX}-brand$(sanitize "${BRAND}")"
        [ -n "${LCD_DENSITY}" ] && BUILD_SUFFIX="${BUILD_SUFFIX}-dpi${LCD_DENSITY}"
        [ -n "${PRODUCT_NAME}" ] && BUILD_SUFFIX="${BUILD_SUFFIX}-prod$(sanitize "${PRODUCT_NAME}")"
        [ -n "${BUILD_PRODUCT}" ] && BUILD_SUFFIX="${BUILD_SUFFIX}-build$(sanitize "${BUILD_PRODUCT}")"
        # Include feature flags in ZIP filename when enabled
        if [ "${OPTIMIZE_VOLUME}" = "true" ]; then
          BUILD_SUFFIX="${BUILD_SUFFIX}-vol"
        fi
        if [ "${BRIGHTNESS_FLOOR}" = "true" ]; then
          BUILD_SUFFIX="${BUILD_SUFFIX}-bright"
        fi

        ZIP_NAME="DeviceInfoFix${BUILD_SUFFIX}-Module.zip"
        echo "ZIP_NAME=${ZIP_NAME}" >> $GITHUB_ENV
        echo "📦 Building: ${ZIP_NAME}"

        # ============================================
        # CRITICAL: Overlay APKs MUST be under system/product/overlay
        # This is the only reliable path for RRO on most ROMs.
        # Previous attempts using vendor/overlay often failed.
        # ============================================
        mkdir -p dist/system/product/overlay

        # Install Battery Overlay APK
        if [ -f build/battery-overlay.apk ]; then
          cp build/battery-overlay.apk dist/system/product/overlay/
          echo "✓ battery-overlay.apk → system/product/overlay/"
        fi

        # Install CPU Overlay APK
        if [ -f build/cpu-overlay.apk ]; then
          cp build/cpu-overlay.apk dist/system/product/overlay/
          echo "✓ cpu-overlay.apk → system/product/overlay/"
        fi

        # Battery capacity config for bind-mount patch (preferred method)
        if [ -n "${BATTERY_CAPACITY}" ]; then
          echo "${BATTERY_CAPACITY}" > dist/battery_capacity.conf
          echo "✓ battery_capacity.conf included (bind-mount patch on boot)"
        fi
        
        # Model name config for device_name override (Bluetooth/Hotspot name)
        if [ -n "${MODEL_NAME}" ]; then
          # Sanitize: remove newlines and = to prevent injection
          safe_model=$(printf '%s' "${MODEL_NAME}" | tr -d '\r\n=' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          echo "${safe_model}" > dist/model_name.conf
          echo "✓ model_name.conf included (for device_name override)"
        fi
        
        # Volume curve optimization config
        if [ "${OPTIMIZE_VOLUME}" = "true" ]; then
          touch dist/optimize_volume.conf
          cp module/volume_curve_patch.xml dist/
          echo "✓ Volume curve optimization enabled"
        fi
        
        # Brightness floor guard config
        if [ "${BRIGHTNESS_FLOOR}" = "true" ]; then
          touch dist/brightness_floor.conf
          echo "✓ Brightness floor guard enabled"
        fi

        # Auto-brightness clamp fixer daemon config
        if [ "${AUTO_BRIGHTNESS_FIX}" = "true" ]; then
          echo "true" > dist/auto_brightness_fix.conf
          echo "✓ Auto brightness clamp fixer daemon enabled"
        fi
        
        # Copy module files
        cp module/module.prop dist/
        [ -f module/service.sh ] && cp module/service.sh dist/
        [ -f module/post-fs-data.sh ] && cp module/post-fs-data.sh dist/
        [ -f module/uninstall.sh ] && cp module/uninstall.sh dist/
        
        # Copy scripts directory
        if [ -d module/scripts ]; then
          mkdir -p dist/scripts
          cp module/scripts/*.sh dist/scripts/
          chmod +x dist/scripts/*.sh
          echo "✓ Feature scripts included"
        fi
        
        # Copy system.prop if generated
        if [ -f build/system.prop ]; then
          cp build/system.prop dist/
          echo "✓ system.prop included"
        fi

        # Setup Magisk installer
        mkdir -p dist/META-INF/com/google/android
        cp module/META-INF/com/google/android/update-binary dist/META-INF/com/google/android/
        echo '#MAGISK' > dist/META-INF/com/google/android/updater-script
        chmod +x dist/META-INF/com/google/android/update-binary

        # Create ZIP
        rm -f "${ZIP_NAME}"
        cd dist
        zip -r "../${ZIP_NAME}" .
        echo "✅ Module packaged: ${ZIP_NAME}"

    - name: Clean old releases and tags
      if: ${{ github.event.inputs.clean_history == 'true' }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        set -euo pipefail
        echo "🧹 Cleaning old releases and tags..."
        gh release list --limit 100 --json tagName --jq '.[].tagName' | while read -r tag; do
          echo "Deleting release: $tag"
          gh release delete "$tag" --yes --cleanup-tag || true
        done
        git tag -l | while read -r tag; do
          git push origin --delete "$tag" || true
          git tag -d "$tag" || true
        done
        echo "✅ History cleanup completed"

    - name: Generate Release Tag
      id: tag
      run: |
        trim() {
          local value="$1"
          value="${value#${value%%[![:space:]]*}}"
          value="${value%${value##*[![:space:]]}}"
          printf "%s" "$value"
        }

        BATTERY_CAPACITY=$(trim "${BATTERY_CAPACITY}")
        CPU_NAME=$(trim "${CPU_NAME}")
        DEVICE_ID=$(trim "${DEVICE_ID}")
        LCD_DENSITY=$(trim "${LCD_DENSITY}")

        VERSION="v2.1-$(date +'%Y%m%d-%H%M%S')"
        SUFFIX=""
        [ -n "${BATTERY_CAPACITY}" ] && SUFFIX="${SUFFIX}-${BATTERY_CAPACITY}mAh"
        [ -n "${CPU_NAME}" ] && SUFFIX="${SUFFIX}-cpu"
        [ -n "${DEVICE_ID}" ] && SUFFIX="${SUFFIX}-${DEVICE_ID}"
        [ -n "${LCD_DENSITY}" ] && SUFFIX="${SUFFIX}-${LCD_DENSITY}dpi"
        
        if [ ${#SUFFIX} -gt 50 ]; then
          SUFFIX="${SUFFIX:0:50}"
        fi
        
        TAG="${VERSION}${SUFFIX}"
        echo "tag=$TAG" >> $GITHUB_OUTPUT
        echo "📦 Release tag: $TAG"

    - name: Create Release Notes
      run: |
        trim() {
          local value="$1"
          value="${value#${value%%[![:space:]]*}}"
          value="${value%${value##*[![:space:]]}}"
          printf "%s" "$value"
        }

        BATTERY_CAPACITY=$(trim "${BATTERY_CAPACITY}")
        CPU_NAME=$(trim "${CPU_NAME}")
        DEVICE_ID=$(trim "${DEVICE_ID}")
        MODEL_NAME=$(trim "${MODEL_NAME}")
        BRAND=$(trim "${BRAND}")
        MANUFACTURER=$(trim "${MANUFACTURER}")
        LCD_DENSITY=$(trim "${LCD_DENSITY}")
        PRODUCT_NAME=$(trim "${PRODUCT_NAME}")
        BUILD_PRODUCT=$(trim "${BUILD_PRODUCT}")

        {
          echo "## Device Info Fix Module - Release Build"
          echo ""
          echo "**Build Date**: $(date +'%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "### Configuration"
          echo ""
        } > release_notes.md
        
        if [ -n "${BATTERY_CAPACITY}" ] || [ -n "${CPU_NAME}" ] || [ -n "${DEVICE_ID}" ] || [ -n "${MODEL_NAME}" ] || [ -n "${BRAND}" ] || [ -n "${MANUFACTURER}" ] || [ -n "${LCD_DENSITY}" ] || [ -n "${PRODUCT_NAME}" ] || [ -n "${BUILD_PRODUCT}" ]; then
          echo "| 配置项 | 值 | 说明 |" >> release_notes.md
          echo "|--------|-----|------|" >> release_notes.md
          [ -n "${BATTERY_CAPACITY}" ] && echo "| Battery Capacity | ${BATTERY_CAPACITY} mAh | 电池容量 (bind-mount + RRO) |" >> release_notes.md
          [ -n "${CPU_NAME}" ] && echo "| CPU Name | ${CPU_NAME} | 处理器显示名称 (RRO) |" >> release_notes.md
          [ -n "${DEVICE_ID}" ] && echo "| Device Codename | ${DEVICE_ID} | 仅显示用途 |" >> release_notes.md
          [ -n "${MODEL_NAME}" ] && echo "| Model Name | ${MODEL_NAME} | 机型名称 + marketname |" >> release_notes.md
          [ -n "${BRAND}" ] && echo "| Brand | ${BRAND} | 品牌 |" >> release_notes.md
          [ -n "${MANUFACTURER}" ] && echo "| Manufacturer | ${MANUFACTURER} | 制造商 |" >> release_notes.md
          [ -n "${LCD_DENSITY}" ] && echo "| LCD Density | ${LCD_DENSITY} DPI | 屏幕密度 |" >> release_notes.md
          [ -n "${PRODUCT_NAME}" ] && echo "| Product Name | ${PRODUCT_NAME} | 产品名称 |" >> release_notes.md
          [ -n "${BUILD_PRODUCT}" ] && echo "| Build Product | ${BUILD_PRODUCT} | 构建产品名 |" >> release_notes.md
          if [ "${OPTIMIZE_VOLUME}" = "true" ]; then
            echo "| Volume Optimization | enabled | 优化音量曲线（使音量调节更线性） |" >> release_notes.md
          fi
          if [ "${BRIGHTNESS_FLOOR}" = "true" ]; then
            echo "| Brightness Floor | enabled | 启用最低亮度保护以避免暗环境黑屏 |" >> release_notes.md
          fi
        else
          echo "⚠️ **Default configuration** (no custom parameters)" >> release_notes.md
        fi
        
        {
          echo ""
          echo "### Installation"
          echo ""
          echo "1. Download the ZIP file"
          echo "2. Open Magisk Manager → Modules → Install from storage"
          echo "3. Select the downloaded ZIP file"
          echo "4. Reboot your device"
          echo ""
          echo "### Technical Notes"
          echo ""
          echo "- Overlay APKs are installed to \`system/product/overlay/\` (required path for RRO)"
          echo "- Battery capacity uses dual approach: bind-mount patch (preferred) + RRO fallback"
          echo "- CPU name uses RRO overlay targeting \`com.android.settings\`"
        } >> release_notes.md
        
        echo "📝 Release notes generated"

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: DeviceInfoFixModule
        path: ${{ env.ZIP_NAME }}

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.tag.outputs.tag }}
        name: "Device Info Fix Module ${{ steps.tag.outputs.tag }}"
        body_path: release_notes.md
        files: ${{ env.ZIP_NAME }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
